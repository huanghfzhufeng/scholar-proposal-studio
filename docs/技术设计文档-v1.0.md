# 校研智申 MVP 技术设计文档 v1.0

## 1. 文档信息
- 版本：v1.0
- 日期：2026-02-14
- 状态：设计确认版
- 对应需求：`/Users/zeke/agent dome/NatGrant/docs/需求文档-MVP.md`
- 对应测试：`/Users/zeke/agent dome/NatGrant/docs/测试文档-MVP.md`

## 2. 技术选型（已确认）
1. 大模型供应商：MiniMax 2.5
2. 部署位置：云服务器
3. 检索 API：Tavily（首选，可插拔支持 Bing/SerpAPI）
4. 前端框架：Next.js + Tailwind
5. 后端形态：Next.js BFF（Route Handlers）+ 异步任务队列
6. 数据库：PostgreSQL + Prisma
7. 异步与缓存：Redis（队列、任务状态）
8. 实时进度：SSE（Server-Sent Events）

## 3. 总体架构
- 架构模式：`4 个业务智能体 + 1 个编排器 + 1 个证据质检器`
- 设计目标：
1. 快速交付 MVP（少服务拆分，先单仓全栈）。
2. 强约束可控（避免幻觉引用和流程跑偏）。
3. 可扩展（后续替换模型、检索源、部署形态）。

## 4. 智能体分工
1. 访谈智能体 InterviewAgent
- 输入：用户上下文、历史问答
- 输出：下一轮问题、访谈结构化摘要、信息充分度分值
- 结束条件：分值 >= 0.8 或用户手动结束

2. 大纲智能体 OutlineAgent
- 输入：访谈结构化摘要
- 输出：2-5 套候选大纲
- 约束：必须覆盖“立项依据/研究内容/研究基础”

3. 检索智能体 RetrievalAgent
- 输入：访谈摘要 + 锁定大纲关键词
- 输出：资料库候选条目（标题、链接、摘要、关联章节、评分）
- 约束：学术优先、低质量来源过滤

4. 全文智能体 DraftAgent
- 输入：锁定大纲 + 已选资料库 + 访谈摘要
- 输出：整篇初稿（一次性生成）
- 约束：禁止编造文献，每个一级章节至少 2 条引用

5. 编排器 WorkflowOrchestrator
- 职责：状态流转、任务排队、重试与回退
- 状态机：
  `INTERVIEW -> OUTLINE_CANDIDATES -> OUTLINE_LOCKED -> SOURCES_READY -> DRAFT_READY -> EXPORTABLE`

6. 证据质检器 EvidenceGuard
- 职责：校验正文引用是否全部来自资料库
- 失败处理：触发“重检索 -> 重生成”，最多重试 2 次

## 5. 工程目录规范（强制）
> 每个 agent 必须独立目录，且必须拆分 `agent.ts`、`prompt.ts`、`tools.ts`

```text
src/
  app/
    (routes)/
  api/
    interview/
    outlines/
    sources/
    drafts/
    exports/
  agents/
    interview/
      agent.ts
      prompt.ts
      tools.ts
      schema.ts
      types.ts
      index.ts
    outline/
      agent.ts
      prompt.ts
      tools.ts
      schema.ts
      types.ts
      index.ts
    retrieval/
      agent.ts
      prompt.ts
      tools.ts
      schema.ts
      types.ts
      index.ts
    draft/
      agent.ts
      prompt.ts
      tools.ts
      schema.ts
      types.ts
      index.ts
  orchestrator/
    workflow.ts
    transitions.ts
    guard.ts
  services/
    llm/
      minimax-client.ts
      minimax-messages.ts
    search/
      tavily-client.ts
      bing-adapter.ts
      serpapi-adapter.ts
      ranker.ts
      source-filter.ts
    export/
      docx-exporter.ts
      pdf-exporter.ts
    storage/
      project-repo.ts
      source-repo.ts
      draft-repo.ts
  shared/
    logger.ts
    errors.ts
    constants.ts
    event-stream.ts
  prisma/
    schema.prisma
```

## 6. 文件职责约束
1. `agent.ts`
- 定义智能体入口 `run(input): output`
- 仅做流程编排，不直接写提示词文本

2. `prompt.ts`
- 保存 system/user prompt 模板与变量插槽
- 只负责提示词，不写业务逻辑

3. `tools.ts`
- 定义该智能体可调用工具清单与调用封装
- 工具调用统一在此暴露，禁止 UI 侧直接拼接

4. `schema.ts`
- 定义输入输出校验（建议 zod）

5. `index.ts`
- 对外导出稳定接口，避免内部文件泄漏

## 7. 核心流程
1. 创建项目 -> 启动访谈
2. 访谈智能体动态追问并生成摘要
3. 大纲智能体输出 2-5 套 -> 用户选择并可编辑
4. 锁定大纲 -> 检索智能体构建资料库
5. 用户确认资料库 -> 全文智能体整篇生成
6. 证据质检器校验引用
7. 通过后进入编辑页，支持 Word/PDF 导出
8. 删除项目进入水库，可恢复

## 8. API 设计（MVP）
1. `POST /api/projects`：新建项目
2. `POST /api/interview/next`：获取下一问并保存回答
3. `POST /api/interview/finish`：手动结束访谈
4. `POST /api/outlines/generate`：生成 2-5 套大纲
5. `POST /api/outlines/lock`：锁定大纲版本
6. `POST /api/sources/search`：触发联网检索
7. `POST /api/sources/select`：纳入/排除资料
8. `POST /api/drafts/generate`：一键整篇生成
9. `GET /api/jobs/:id/stream`：SSE 任务进度
10. `POST /api/exports/docx`：导出 Word
11. `POST /api/exports/pdf`：导出 PDF
12. `DELETE /api/projects/:id`：软删除
13. `POST /api/projects/:id/restore`：从水库恢复

## 9. 数据模型（核心）
1. `projects`
- `id`, `title`, `status`, `deleted_at`, `created_at`, `updated_at`

2. `interview_turns`
- `project_id`, `role`, `content`, `round`, `sufficiency_score`

3. `requirement_snapshots`
- `project_id`, `summary_json`, `version`

4. `outline_versions`
- `project_id`, `version`, `is_locked`, `outline_json`, `diff_from_prev`

5. `sources`
- `project_id`, `url`, `title`, `abstract`, `score`, `section_key`, `quality_flag`

6. `source_selections`
- `project_id`, `source_id`, `selected`

7. `draft_versions`
- `project_id`, `version`, `content_md`, `quality_report_json`

8. `export_jobs`
- `project_id`, `type`, `status`, `file_path`

## 10. 质量守卫规则
1. 访谈充分度守卫：`score >= 0.8` 或手动结束
2. 引用守卫：每个一级章节至少 2 条来源
3. 来源守卫：低质量站点过滤
4. 幻觉守卫：资料库外引用默认拦截
5. 重试守卫：失败自动重检索/重生成，最大 2 次

## 11. 可观察性与日志
1. 每个任务有 `trace_id`，贯穿访谈/大纲/检索/生成/导出
2. 关键事件写结构化日志（JSON）
3. SSE 推送事件：`queued`, `running`, `step_done`, `failed`, `completed`

## 12. 安全与数据管理（MVP）
1. 暂不接 SSO，采用最小登录策略或测试账号。
2. 软删除归档，不做物理删除。
3. 导出文件按项目隔离存储，按任务授权下载。

## 13. 部署建议（云服务器）
1. `web`：Next.js 应用（含 API）
2. `worker`：异步任务处理进程
3. `db`：PostgreSQL
4. `redis`：队列与状态
5. `object storage`：导出文件存储

## 14. 开发顺序
1. 第 1 阶段：目录骨架 + 4 智能体接口空实现 + 编排状态机
2. 第 2 阶段：访谈/大纲闭环
3. 第 3 阶段：检索/资料库闭环
4. 第 4 阶段：整篇生成 + 证据质检器
5. 第 5 阶段：编辑导出 + 软删除恢复 + 测试验收
